<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurant IA - Dashboard Simplifi√©</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #020617;
            --bg-surface: #0f172a;
            --border-color: #334155;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --accent-blue: #38bdf8;
            --accent-purple: #a78bfa;
            --accent-orange: #f97316;
            --accent-green: #4ade80;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-primary);
            padding-bottom: 80px; 
        }
        .page {
            animation: fadeIn 0.4s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .nav-button {
            @apply px-4 py-2 text-lg font-semibold text-text-secondary border-b-2 border-transparent transition-all duration-200 hover:text-white;
        }
        .nav-button.active {
            @apply text-accent-blue border-accent-blue;
        }
        .main-card {
            @apply bg-bg-surface p-6 rounded-2xl border border-border-color shadow-2xl shadow-black/20;
        }
        .page-title {
            @apply text-4xl font-bold text-white mb-8;
        }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
        .typing-indicator span { display: inline-block; width: 8px; height: 8px; border-radius: 50%; background-color: var(--text-secondary); animation: bounce 1.4s infinite ease-in-out both; }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
    </style>
</head>
<body>
    <!-- Barre de navigation sup√©rieure -->
    <header class="bg-bg-surface/80 backdrop-blur-lg sticky top-0 z-40 border-b border-border-color">
        <div class="container mx-auto px-6 h-20 flex items-center justify-between">
            <h1 class="text-2xl font-bold">üçΩÔ∏è Restaurant IA</h1>
            <nav class="hidden md:flex items-center gap-6">
                <button id="home-nav" class="nav-button active" onclick="showPage('home')">Accueil</button>
                <button id="planning-nav" class="nav-button" onclick="showPage('planning')">Planning</button>
                <button id="hours-nav" class="nav-button" onclick="showPage('hours')">Heures</button>
            </nav>
            <div></div>
        </div>
    </header>

    <!-- Contenu principal -->
    <main class="container mx-auto p-6 md:p-8">
        <!-- PAGE 1: ACCUEIL -->
        <div id="home-page" class="page">
            <h2 class="page-title">Bienvenue !</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="main-card">
                    <h3 class="text-2xl font-bold mb-4">Pr√©sents Aujourd'hui</h3>
                    <div id="team-today" class="space-y-3"></div>
                </div>
                <div class="main-card flex flex-col justify-between">
                    <div>
                        <h3 class="text-2xl font-bold mb-4">Aper√ßu de la Semaine</h3>
                        <div id="weekly-overview" class="space-y-4"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mt-6">
                         <button onclick="showPage('planning')" class="p-4 bg-purple-600/20 text-purple-300 rounded-lg font-semibold text-center hover:bg-purple-600/40 transition">Voir le Planning</button>
                         <button onclick="showPage('hours')" class="p-4 bg-orange-600/20 text-orange-300 rounded-lg font-semibold text-center hover:bg-orange-600/40 transition">Voir les Heures</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- PAGE 2: PLANNING -->
        <div id="planning-page" class="page hidden">
            <h2 class="page-title">üìÖ Planning de la Semaine</h2>
            <div class="main-card">
                <div id="planning-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 xl:grid-cols-7 gap-6"></div>
            </div>
        </div>

        <!-- PAGE 3: HEURES -->
        <div id="hours-page" class="page hidden">
            <h2 class="page-title">‚è±Ô∏è Suivi des Heures R√©elles</h2>
            <div class="main-card">
                <div id="employees-hours-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </div>
        </div>
    </main>

    <!-- Bouton flottant -->
    <button onclick="openChatModal()" class="fixed bottom-24 right-6 size-16 bg-accent-blue rounded-full shadow-lg flex items-center justify-center text-white z-50 transform hover:scale-110 transition-transform md:bottom-6">
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 21 1.9-5.7a8.5 8.5 0 1 1 3.8 3.8z"/></svg>
    </button>
    
    <!-- Navigation mobile -->
    <nav class="md:hidden fixed bottom-0 left-0 right-0 bg-bg-surface h-20 border-t border-border-color flex justify-around items-center z-40">
        <button id="home-nav-mobile" class="nav-button active" onclick="showPage('home')">Accueil</button>
        <button id="planning-nav-mobile" class="nav-button" onclick="showPage('planning')">Planning</button>
        <button id="hours-nav-mobile" class="nav-button" onclick="showPage('hours')">Heures</button>
    </nav>

    <!-- Modale de Chat IA -->
    <div id="chat-modal" class="fixed inset-0 z-[100] hidden items-center justify-center p-4">
        <div class="fixed inset-0 bg-black/70" onclick="closeChatModal()"></div>
        <div class="main-card w-full max-w-2xl h-[70vh] flex flex-col z-10">
            <h3 class="text-2xl font-bold text-white mb-4">Assistant IA</h3>
            <div id="chat-messages" class="flex-1 overflow-y-auto p-2 space-y-4">
                <div class="p-3 rounded-lg bg-slate-800 max-w-md">Bonjour ! Comment puis-je vous aider √† g√©rer le restaurant ?</div>
            </div>
            <div class="mt-4 flex items-center gap-3">
                <div class="relative flex-1">
                    <input id="chat-input" type="text" class="w-full bg-slate-800 p-4 rounded-lg border-2 border-transparent focus:border-accent-blue focus:outline-none pr-24" placeholder="Ex: cr√©e le planning de la semaine">
                    <div class="absolute right-3 top-1/2 -translate-y-1/2 flex gap-1">
                        <button title="Photo" class="size-10 rounded-full flex items-center justify-center text-text-secondary hover:bg-slate-700 transition">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3.5L14.5 4Z"/><circle cx="12" cy="13" r="3"/></svg>
                        </button>
                        <button title="Vocal" class="size-10 rounded-full flex items-center justify-center text-text-secondary hover:bg-slate-700 transition">
                             <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg>
                        </button>
                    </div>
                </div>
                <button id="chat-send" class="size-14 rounded-lg bg-accent-blue text-white flex items-center justify-center shrink-0">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
                </button>
            </div>
        </div>
    </div>

<script>
    const N8N_WEBHOOK_URL = 'https://morzinecap.app.n8n.cloud/webhook/23ed6cad-a469-446c-bccd-fe294d0f1839';
    
    const elements = {
        pages: document.querySelectorAll('.page'),
        navButtons: document.querySelectorAll('.nav-button'),
        teamToday: document.getElementById('team-today'),
        weeklyOverview: document.getElementById('weekly-overview'),
        planningGrid: document.getElementById('planning-grid'),
        employeesHoursGrid: document.getElementById('employees-hours-grid'),
        chatModal: document.getElementById('chat-modal'),
        chatMessages: document.getElementById('chat-messages'),
        chatInput: document.getElementById('chat-input'),
        chatSend: document.getElementById('chat-send'),
    };
    
    function showPage(pageId) {
        elements.pages.forEach(p => p.classList.add('hidden'));
        document.getElementById(`${pageId}-page`).classList.remove('hidden');
        elements.navButtons.forEach(b => {
            b.classList.remove('active');
            if (b.id.startsWith(pageId)) b.classList.add('active');
        });
        window.scrollTo(0, 0);
    }

    function openChatModal() { elements.chatModal.classList.remove('hidden'); elements.chatModal.classList.add('flex'); elements.chatInput.focus(); }
    function closeChatModal() { elements.chatModal.classList.add('hidden'); elements.chatModal.classList.remove('flex'); }
    
    async function sendMessageToN8N(payload) {
        try {
            const response = await fetch(N8N_WEBHOOK_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
            return await response.json();
        } catch (error) {
            console.error("Erreur de communication avec n8n:", error);
            return { error: true, message: "D√©sol√©, une erreur de communication est survenue." };
        }
    }

    function setLoadingState(message = "Chargement...") {
        const loadingHTML = `<p class="text-text-secondary">${message}</p>`;
        elements.teamToday.innerHTML = loadingHTML;
        elements.weeklyOverview.innerHTML = loadingHTML;
        elements.planningGrid.innerHTML = loadingHTML;
        elements.employeesHoursGrid.innerHTML = loadingHTML;
    }

    function updateUI(data) {
        if (!data || !data.employees || !data.planning || !data.dashboard) {
            console.error("Donn√©es invalides pour la mise √† jour de l'UI.", data);
            const errorHTML = `<p class="text-red-400">Erreur: Impossible de charger les donn√©es. V√©rifiez la console.</p>`;
            elements.teamToday.innerHTML = errorHTML;
            elements.weeklyOverview.innerHTML = errorHTML;
            elements.planningGrid.innerHTML = errorHTML;
            elements.employeesHoursGrid.innerHTML = errorHTML;
            return;
        }
        const { employees, planning, dashboard } = data;
        
        elements.teamToday.innerHTML = employees.filter(e => e.present).map(emp => `
            <div class="flex items-center justify-between bg-slate-800 p-3 rounded-lg">
                <p class="font-bold">${emp.nom} <span class="text-sm font-normal text-text-secondary">(${emp.role})</span></p>
                <div class="flex items-center gap-2 text-green-400"><span class="size-2 bg-accent-green rounded-full"></span><span class="text-sm font-semibold">Pr√©sent</span></div>
            </div>`).join('') || `<p class="text-text-secondary">Personne n'est indiqu√© comme pr√©sent.</p>`;
        
        elements.weeklyOverview.innerHTML = `
            <div class="flex items-center justify-between text-lg"><span class="text-text-secondary">Total heures pr√©vues :</span><span class="font-bold">${dashboard.totalHeures}h</span></div>
            <div class="flex items-center justify-between text-lg"><span class="text-text-secondary">Total heures supp. :</span><span class="font-bold text-orange-400">${dashboard.totalHeuresSupp}h</span></div>`;
        
        const days = ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi', 'Dimanche'];
        elements.planningGrid.innerHTML = days.map(day => {
            const dayFormatted = day.charAt(0).toUpperCase() + day.slice(1);
            const midiStaff = planning.filter(p => p.day.toLowerCase() === day.toLowerCase() && p.service === 'Midi').flatMap(p => p.employes).join(', ') || 'Ferm√©';
            const soirStaff = planning.filter(p => p.day.toLowerCase() === day.toLowerCase() && p.service === 'Soir').flatMap(p => p.employes).join(', ') || 'Ferm√©';
            return `<div class="bg-slate-800 p-4 rounded-xl"><h4 class="font-bold text-center text-lg mb-3">${dayFormatted}</h4><div class="space-y-2">
                <div class="bg-slate-900 p-3 rounded-md"><p class="font-semibold text-purple-300">Midi</p><p class="text-sm text-text-secondary">${midiStaff}</p></div>
                <div class="bg-slate-900 p-3 rounded-md"><p class="font-semibold text-purple-300">Soir</p><p class="text-sm text-text-secondary">${soirStaff}</p></div>
            </div></div>`
        }).join('');

        elements.employeesHoursGrid.innerHTML = employees.map(emp => {
            const percentage = emp.heuresContrat > 0 ? (emp.heuresSemaine / emp.heuresContrat) * 100 : 0;
            return `<div class="bg-slate-800 p-5 rounded-xl"><div class="flex justify-between items-start"><div><h4 class="text-xl font-bold">${emp.nom}</h4><p class="text-text-secondary">${emp.role}</p></div>${emp.heuresSupp > 0 ? `<div class="px-3 py-1 bg-orange-500 text-white text-sm font-bold rounded-full">+${emp.heuresSupp}h</div>` : ''}</div><div class="mt-4"><div class="flex justify-between text-sm text-text-secondary mb-1"><span>${emp.heuresSemaine}h / ${emp.heuresContrat}h</span><span>${Math.round(percentage)}%</span></div><div class="w-full bg-slate-900 rounded-full h-2.5"><div class="bg-accent-blue h-2.5 rounded-full" style="width: ${Math.min(percentage, 100)}%"></div></div></div></div>`
        }).join('');
    }
    
    function appendChatMessage(message, sender) {
        const alignClass = sender === 'user' ? 'justify-end' : 'justify-start';
        const colorClass = sender === 'user' ? 'bg-blue-600' : 'bg-slate-800';
        const html = `<div class="flex ${alignClass}"><div class="p-3 rounded-lg ${colorClass} max-w-md">${message}</div></div>`;
        elements.chatMessages.innerHTML += html;
        elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
    }

    function showTypingIndicator() {
        const html = `<div id="typing-indicator" class="flex justify-start"><div class="p-3 rounded-lg bg-slate-800"><div class="typing-indicator"><span></span><span></span><span></span></div></div></div>`;
        elements.chatMessages.innerHTML += html;
        elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
    }

    function hideTypingIndicator() {
        const indicator = document.getElementById('typing-indicator');
        if(indicator) indicator.remove();
    }

    async function loadInitialData() {
        setLoadingState("Connexion au robot n8n...");
        const response = await sendMessageToN8N({ text: "g√©n√®re le planning pour le dashboard" });
        if (response && !response.error && response[0]?.json?.employees) {
            updateUI(response[0].json);
        } else {
             console.error("R√©ponse invalide du workflow pour les donn√©es initiales :", response);
             updateUI(null); // D√©clenche l'affichage d'erreur
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        showPage('home');
        loadInitialData();
        
        const handleSend = async () => {
            const input = elements.chatInput;
            const userMessage = input.value.trim();
            if(userMessage === '') return;
            
            appendChatMessage(userMessage, 'user');
            input.value = '';
            showTypingIndicator();

            const iaResponse = await sendMessageToN8N({ text: userMessage });
            
            hideTypingIndicator();
            
            let responseMessage = "Action trait√©e avec succ√®s.";
            let shouldRefresh = true;

            if (iaResponse.error) {
                responseMessage = iaResponse.message;
                shouldRefresh = false;
            } else if (iaResponse[0]?.json?.employees) {
                responseMessage = "Le planning a √©t√© mis √† jour.";
                updateUI(iaResponse[0].json);
                shouldRefresh = false; 
            } else if (iaResponse[0]?.json?.message) {
                responseMessage = iaResponse[0].json.message;
            }

            appendChatMessage(responseMessage, 'ia');

            if (shouldRefresh) {
                setLoadingState("Mise √† jour des donn√©es...");
                await loadInitialData();
            }
        };

        elements.chatSend.addEventListener('click', handleSend);
        elements.chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleSend();
            }
        });
    });
</script>
</body>
</html>
